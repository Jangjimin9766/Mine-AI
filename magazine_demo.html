<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M:ine AI Magazine Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen">

    <!-- Auth Modal (Overlay) -->
    <div id="authModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden">
            <!-- Login Form -->
            <div id="loginForm" class="p-8">
                <h2 class="text-3xl font-extrabold text-center mb-2">Welcome Back ğŸ‘‹</h2>
                <p class="text-center text-gray-500 mb-8">ë‚˜ë§Œì˜ AI ë§¤ê±°ì§„ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="loginEmail"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-black outline-none transition"
                            placeholder="name@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="loginPassword"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-black outline-none transition"
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <button onclick="login()"
                        class="w-full bg-black text-white font-bold py-4 rounded-xl hover:bg-gray-800 transition transform active:scale-95">
                        ë¡œê·¸ì¸
                    </button>
                </div>
                <p class="text-center mt-6 text-sm text-gray-500">
                    ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <button onclick="toggleAuth('signup')"
                        class="text-black font-bold hover:underline">íšŒì›ê°€ì…</button>
                </p>
            </div>

            <!-- Signup Form (Hidden) -->
            <div id="signupForm" class="p-8 hidden">
                <h2 class="text-3xl font-extrabold text-center mb-2">Join M:ine AI ğŸš€</h2>
                <p class="text-center text-gray-500 mb-8">ìƒˆë¡œìš´ ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤</p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="signupEmail"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-black outline-none transition"
                            placeholder="name@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nickname</label>
                        <input type="text" id="signupNickname"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-black outline-none transition"
                            placeholder="User Name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="signupPassword"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-black outline-none transition"
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <button onclick="signup()"
                        class="w-full bg-black text-white font-bold py-4 rounded-xl hover:bg-gray-800 transition transform active:scale-95">
                        íšŒì›ê°€ì…
                    </button>
                </div>
                <p class="text-center mt-6 text-sm text-gray-500">
                    ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button onclick="toggleAuth('login')"
                        class="text-black font-bold hover:underline">ë¡œê·¸ì¸</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden until logged in) -->
    <div id="mainApp" class="max-w-4xl mx-auto p-6 hidden filter blur-sm transition-all duration-500">
        <!-- Header -->
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900">âœ¨ M:ine AI Magazine</h1>
                <p class="text-gray-500 text-sm">AIê°€ ë§Œë“œëŠ” ë‚˜ë§Œì˜ íŒ¨ì…˜ ë§¤ê±°ì§„</p>
            </div>
            <div class="flex items-center gap-4">
                <span id="userDisplay"
                    class="text-sm font-medium text-gray-600 bg-gray-100 px-3 py-1 rounded-full"></span>
                <button onclick="logout()" class="text-sm text-red-500 font-bold hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <!-- Input Section -->
        <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì£¼ì œ (Topic)</label>
                    <input type="text" id="topicInput" placeholder="ì˜ˆ: 2024 ê²¨ìš¸ ë¯¸ë‹ˆë©€ ë£©"
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition">
                </div>
                <div class="w-full md:w-1/3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë¬´ë“œ (Mood)</label>
                    <input type="text" id="moodInput" placeholder="ì˜ˆ: ì‹œí¬, ëª¨ë˜"
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition">
                </div>
            </div>

            <div class="flex gap-4 mt-6">
                <button onclick="generateMagazine()"
                    class="flex-1 bg-black text-white font-bold py-4 rounded-xl hover:bg-gray-800 transition transform hover:scale-[1.01] active:scale-[0.99] shadow-md">
                    ë§¤ê±°ì§„ ìƒì„±í•˜ê¸°
                </button>
                <button onclick="loadMagazines()"
                    class="flex-1 bg-white text-black border-2 border-black font-bold py-4 rounded-xl hover:bg-gray-50 transition transform hover:scale-[1.01] active:scale-[0.99] shadow-md">
                    ë‚´ ë§¤ê±°ì§„ ëª©ë¡ ë³´ê¸°
                </button>
            </div>
        </div>

        <!-- Magazine List Section -->
        <div id="magazineListSection" class="hidden mb-12 animate-fade-in-up">
            <h2 class="text-2xl font-bold mb-6">ğŸ“š ë‚´ ë§¤ê±°ì§„ ëª©ë¡</h2>
            <div id="magazineListContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- List items will be injected here -->
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="hidden text-center py-20">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-lg text-gray-600 animate-pulse">AIê°€ ìµœì‹  íŠ¸ë Œë“œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br><span
                    class="text-sm text-gray-400">(ì•½ 15~30ì´ˆ ì†Œìš”)</span></p>
        </div>

        <!-- Result Section -->
        <div id="result" class="hidden space-y-8 animate-fade-in-up">
            <!-- Cover -->
            <div class="bg-white rounded-3xl shadow-xl overflow-hidden">
                <div class="relative h-96">
                    <img id="coverImage" src="" alt="Cover" class="w-full h-full object-cover">
                    <div
                        class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex flex-col justify-end p-8">
                        <div id="tags" class="flex gap-2 mb-4 flex-wrap"></div>
                        <h2 id="magTitle" class="text-4xl md:text-5xl font-bold text-white leading-tight mb-2"></h2>
                    </div>
                </div>
                <div class="p-8 md:p-10">
                    <p id="introduction"
                        class="text-xl text-gray-600 leading-relaxed font-light italic border-l-4 border-black pl-6">
                    </p>
                </div>
            </div>

            <!-- Sections Container -->
            <div id="sectionsContainer" class="space-y-8"></div>
        </div>
    </div>

    <script>
        const SPRING_URL = 'http://localhost:8080';

        // --- Auth Logic ---
        function checkAuth() {
            const token = localStorage.getItem('accessToken');
            const email = localStorage.getItem('userEmail');

            if (token && email) {
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden', 'filter', 'blur-sm');
                document.getElementById('userDisplay').innerText = `Logged in as: ${email}`;
            } else {
                document.getElementById('authModal').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden', 'filter', 'blur-sm');
            }
        }

        function toggleAuth(mode) {
            if (mode === 'signup') {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('signupForm').classList.remove('hidden');
            } else {
                document.getElementById('signupForm').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
            }
        }

        async function signup() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const nickname = document.getElementById('signupNickname').value;

            if (!email || !password || !nickname) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            try {
                const res = await fetch(`${SPRING_URL}/api/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, nickname })
                });

                if (res.ok) {
                    alert("íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    toggleAuth('login');
                } else {
                    alert("íšŒì›ê°€ì… ì‹¤íŒ¨: " + (await res.text()));
                }
            } catch (e) { alert("ì„œë²„ ì˜¤ë¥˜: " + e.message); }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) return alert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            try {
                const res = await fetch(`${SPRING_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (res.ok) {
                    const data = await res.json();
                    // Assuming response is { accessToken: "...", ... }
                    if (data.accessToken) {
                        localStorage.setItem('accessToken', data.accessToken);
                        localStorage.setItem('userEmail', email);
                        checkAuth();
                    } else {
                        alert("í† í°ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì‘ë‹µì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    }
                } else {
                    alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + (await res.text()));
                }
            } catch (e) { alert("ì„œë²„ ì˜¤ë¥˜: " + e.message); }
        }

        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userEmail');
            location.reload();
        }

        // --- Magazine Logic ---
        async function generateMagazine() {
            const topic = document.getElementById('topicInput').value;
            const mood = document.getElementById('moodInput').value;
            const token = localStorage.getItem('accessToken'); // Need token for Spring

            if (!token) return logout();

            if (!topic) {
                alert("ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            // UI Reset
            document.getElementById('result').classList.add('hidden');
            document.getElementById('magazineListSection').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('sectionsContainer').innerHTML = '';

            try {
                // Gateway Pattern: Call Spring, not Python
                const response = await fetch(`${SPRING_URL}/api/magazines`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ topic: topic, mood: mood }) // Spring DTO might expect 'mood', not 'user_mood'
                });

                if (!response.ok) throw new Error('Network response was not ok: ' + await response.text());

                // Spring returns the ID of the created magazine
                const newMagazineId = await response.json();

                // Fetch the full details using the ID
                await loadMagazineDetail(newMagazineId);

            } catch (error) {
                alert("ìƒì„± ì‹¤íŒ¨: " + error.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        async function loadMagazines() {
            const token = localStorage.getItem('accessToken');
            if (!token) return logout();

            const listSection = document.getElementById('magazineListSection');
            const listContainer = document.getElementById('magazineListContainer');

            // Hide other sections
            document.getElementById('result').classList.add('hidden');
            listSection.classList.remove('hidden');

            listContainer.innerHTML = '<div class="col-span-2 text-center py-10"><div class="loader mx-auto"></div></div>';

            try {
                // Call Spring Server with Token
                const response = await fetch(`${SPRING_URL}/api/magazines`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch magazines');

                const magazines = await response.json();
                renderMagazineList(magazines);

            } catch (error) {
                listContainer.innerHTML = `<div class="col-span-2 text-center text-red-500 py-4">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>(${error.message})</div>`;
            }
        }

        async function loadMagazineDetail(id) {
            const token = localStorage.getItem('accessToken');
            if (!token) return logout();

            // Show loading
            document.getElementById('magazineListSection').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');

            try {
                const response = await fetch(`${SPRING_URL}/api/magazines/${id}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch magazine detail');

                const data = await response.json();
                renderMagazine(data, true); // true = show back button

            } catch (error) {
                alert("ìƒì„¸ë³´ê¸° ì‹¤íŒ¨: " + error.message);
                document.getElementById('magazineListSection').classList.remove('hidden'); // Show list again
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function renderMagazine(data, showBackButton = false) {
            const resultSection = document.getElementById('result');
            resultSection.classList.remove('hidden');

            // Back Button Logic
            const existingBackBtn = document.getElementById('backToResultBtn');
            if (existingBackBtn) existingBackBtn.remove();

            if (showBackButton) {
                const backBtn = document.createElement('button');
                backBtn.id = 'backToResultBtn';
                backBtn.className = 'mb-6 flex items-center text-gray-600 hover:text-black font-bold transition';
                backBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg> ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
                backBtn.onclick = () => {
                    resultSection.classList.add('hidden');
                    document.getElementById('magazineListSection').classList.remove('hidden');
                };
                resultSection.prepend(backBtn);
            }

            // Header
            document.getElementById('magTitle').innerText = data.title;
            document.getElementById('introduction').innerText = data.introduction;
            document.getElementById('coverImage').src = data.cover_image_url || data.coverImageUrl || 'https://via.placeholder.com/800x400?text=No+Image';

            // Tags
            const tagsContainer = document.getElementById('tags');
            if (data.tags) {
                tagsContainer.innerHTML = data.tags.map(tag =>
                    `<span class="bg-white/20 backdrop-blur-md text-white px-3 py-1 rounded-full text-sm font-medium">#${tag}</span>`
                ).join('');
            } else {
                tagsContainer.innerHTML = '';
            }

            // Sections
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = ''; // Clear previous sections

            if (data.sections) {
                data.sections.forEach((section, index) => {
                    const isImageLeft = index % 2 === 0; // Alternate layout

                    let html = '';
                    if (section.image_url || section.imageUrl) {
                        html = `
                            <div class="bg-white rounded-2xl shadow-md overflow-hidden flex flex-col md:flex-row ${isImageLeft ? '' : 'md:flex-row-reverse'}">
                                <div class="md:w-1/2 h-64 md:h-auto">
                                    <img src="${section.image_url || section.imageUrl}" class="w-full h-full object-cover hover:scale-105 transition duration-700">
                                </div>
                                <div class="p-8 md:w-1/2 flex flex-col justify-center">
                                    <h3 class="text-2xl font-bold mb-4 text-gray-800">${section.heading}</h3>
                                    <p class="text-gray-600 leading-relaxed">${section.content}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        html = `
                            <div class="bg-white rounded-2xl shadow-md p-8">
                                <h3 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">${section.heading}</h3>
                                <p class="text-gray-600 leading-relaxed">${section.content}</p>
                            </div>
                        `;
                    }
                    container.innerHTML += html;
                });
            }
        }

        function renderMagazineList(magazines) {
            const container = document.getElementById('magazineListContainer');
            container.innerHTML = '';

            if (magazines.length === 0) {
                container.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-10">ìƒì„±ëœ ë§¤ê±°ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            magazines.forEach(mag => {
                const html = `
                    <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition cursor-pointer border border-gray-100" onclick="loadMagazineDetail(${mag.id})">
                        <div class="h-48 overflow-hidden">
                            <img src="${mag.cover_image_url || mag.coverImageUrl || 'https://via.placeholder.com/400x200'}" class="w-full h-full object-cover hover:scale-105 transition duration-500">
                        </div>
                        <div class="p-5">
                            <h3 class="font-bold text-lg mb-2 line-clamp-1">${mag.title}</h3>
                            <p class="text-sm text-gray-500 line-clamp-2">${mag.introduction}</p>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // Initialize
        checkAuth();
    </script>
</body>

</html>
```